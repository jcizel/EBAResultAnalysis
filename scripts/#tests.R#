load_all()

banks <- loadManuallyLinkedBanks()

t1 <- collapseManuallyLinkedTable(dt = banks)

t2 <- t1[, lapply(.SD, collapseDuplicatesWithinString)]

t2[, bscode.unique := selectUniqueBSIndex(bscode)]


write.csv(
    x = output4,
    file = "MANUAL_CHECK_RESHAPED.csv"
)

## .test <- c("22308 (U1)", "29758 (U*)")
## .test[grepl(x = .test,
##             pattern = "C2")]

query = "AQR2014"

QUERYSTRESSTEST <- function (query,
                             outfile){
    out <- 
        output4[grepl(x = presence, pattern = toupper(query)), {
            l <- strsplit(names,split = "; ")

            names <- 
                sapply(l, function (str.vec ) {
                    o <- unique(.trim(str.vec))
                    cat("#### OBJECT:",dput(o),"\n")
                    cat("## Query: ", dput(query),"\n")
                    .o <- 
                        o[grepl(x = o,
                                pattern = query)]
                    cat("## NEW OBJECT:",dput(.o),"\n")
                    cat("## LENGTH OF NEW OBJECT:",length(.o),"\n")                
                    if (length(.o)>1) {
                        ## stop("Query matches multiple names")
                        warning("Query matches multiple names")
                        return(.o[[1]])
                    }
                    return(.o)
                })

            names <- .trim(gsub(x = names, pattern = '(.*)\\[\\[.*\\]\\]','\\1'))
            
            list(names = names,
                 ebacode = ebacode,
                 leicode = leicode,
                 bscode = bscode.unique)
        }]

    write.csv(
        x = out,
        file = paste0(outfile,".csv")
    )
}

QUERYSTRESSTEST(query = "AQR2014",
                outfile = "LOOKUP_AQR2014")
QUERYSTRESSTEST(query = "STRESSTEST2011",
                outfile = "LOOKUP_STRESSTEST2011")
QUERYSTRESSTEST(query = "STRESSTEST2014",
                outfile = "LOOKUP_STRESSTEST2014")
QUERYSTRESSTEST(query = "EBARECAP2012",
                outfile = "LOOKUP_EBARECAP2012")
QUERYSTRESSTEST(query = "EBATRANSPARENCY2013",
                outfile = "LOOKUP_EBATRANSPARENCY2013")



